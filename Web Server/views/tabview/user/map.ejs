<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="">
  <meta name="author" content="">
  <title>Hệ thống giám sát vận tải đường dài</title>
  <!-- T A B I C O N -->
    <link rel="icon" type="image/png" href="/images/static/ico_1.png">
    <link href="/styles/dashboard/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="/styles/bootstrap.min.css" rel="stylesheet">
    <link href="/styles/dashboard/vendor/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">


  <style>
    #map {
      height: 90%;
    }
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }
  </style>

  <script type="text/javascript">
    window.SAILS_LOCALS = {
      me: <%- typeof me !== 'undefined' ? JSON.stringify(me) : 'null' %>
    };
    </script>

  </head>
<body ng-app="MapTabModule" ng-controller="MapTabController" ng-cloak>
  <div class="card-header">
    <i class="fa fa-map-marker"></i>
     Thiết bị: <select id="SearchMapByDevId" onchange="initMap()"></select>
     <span id="warning"></span>
     <a class="btn btn-primary" onclick="initMap()" style="line-height: 0.8em;"><i class="fa fa-retweet"></i> Cập nhật</a>
     <span>Từ: <input type="datetime-local" name="start" id="start" style="line-height: 1em; width: 200px;"></span>
     <span>Đến: <input type="datetime-local" name="end" id="end" style="line-height: 1em; width: 200px;"></span>
     <span style="padding-left: 2rem">Tập trung:
        <select id="focusPoints" type="number">
           <option value=5>5</option>
           <option value=10>10</option>
           <option value=15>15</option>
           <option value=20>20</option>
           <option value=30 selected>30</option>
           <option value=40>40</option>
           <option value=60>60</option>
        </select> điểm mới nhất 
     </span>
     <span style="padding-left: 2rem">Cập nhật:</span><input type="text" name="updateAt" id="updateAt" placeholder="" style="width: 160px" disabled> 
     <a href="/tabview/user/map" target="_blank" class="float-right" style="color: red; font-weight: bold;"><i class="fa fa-arrows-alt" style="color: red; padding-left: 2rem;"></i> Phóng to</a>
   </div>
   <div id="map"></div>


    <script src="/js/dependencies/sails.io.js"></script>
    <script src="/js/dependencies/angular.1.3.js"></script>
    <script src="/js/dependencies/angular-toastr.js"></script>
    <script src="/js/dependencies/compareTo.module.js"></script>
    <script src="/js/controllers/private/dashboard/user/tab/MapTabModule.js"></script>
    <script src="/js/controllers/private/dashboard/user/tab/MapTabController.js"></script>

    <!-- SCRIPT FOR SELECT OPTIONS -->
    <script>
      window.onload = function(){
        $.get('/service/GetServiceList', function(getRes, status){

          var option = document.createElement("option");
          option.text = "";
          option.value = "";
          document.getElementById("SearchMapByDevId").add(option);
          for (var i = 0; i < getRes.length; i++) {
            var option = document.createElement("option");
            option.text = getRes[i].devid.toString();
            option.value = getRes[i].devid;
            document.getElementById("SearchMapByDevId").add(option);
          }
        });
      }
    </script>

    <!-- SCRIPT FOR GOGLE MAP -->
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
    <script>
      function initMap() {
        if((document.getElementById('SearchMapByDevId').value != "") && (document.getElementById('focusPoints').value != ""))
        {
          $.post('/data_collect/PostMapDataByID', {
            start: document.getElementById('start').value,
            end: document.getElementById('end').value,
            devid: document.getElementById('SearchMapByDevId').value,
          }, function(data, status){

            var TrackingCoordinates = [];

            for (var i = 0; i < data.length; i++) {
              TrackingCoordinates.push(
                {lat: data[i].Lat, lng: data[i].Long}
              );
            }//for
            
            var latSum = 0, lngSum = 0;
            var focusDesire = document.getElementById('focusPoints').value;
            var centralize = {};
            if(data.length < focusDesire){
              for(var i = 0; i < data.length; i++){
                latSum += data[i].Lat;
                lngSum += data[i].Long;
              } //for
              centralize.lat = latSum/data.length;
              centralize.lng = lngSum/data.length;
            }
            else{
              for(var i = 0; i < focusDesire; i++){
                latSum += data[data.length - i - 1].Lat;
                lngSum += data[data.length - i - 1].Long;
              } //for
              centralize.lat = latSum/focusDesire;
              centralize.lng = lngSum/focusDesire;
            }

            var options = {
              zoom: 16,
              center: centralize,
              mapTypeId: 'terrain'
            }; //options
            var map = new google.maps.Map(document.getElementById('map'), options);

            var ContainerPath = new google.maps.Polyline({
              path: TrackingCoordinates,
              geodesic: true,
              strokeColor: '#FF0000',
              strokeOpacity: 1.0,
              strokeWeight: 4
            }); //ContainerPath
            
            ContainerPath.setMap(map);
            /*ADD marker*/
            for(var i = 0; i < TrackingCoordinates.length; i++){
              var marker = new google.maps.Marker({
                position: TrackingCoordinates[i],
                map: map,
                label: i.toString(),
                title: JSON.stringify(TrackingCoordinates[i])
              });
            } //for
            document.getElementById("updateAt").setAttribute("placeholder", new Date().toLocaleString());
          }); //$.post
        }// if(document.getElementById)
        else{
          document.getElementById('map').innerHTML = ' <img src="/images/dashboard/4.gif" alt="Map Not Found" style="width: 100%; height: 100%; center">';
        }

        /*REFRESH AFTER*/
        // if(document.getElementById('refreshAfter').value == '' || document.getElementById('refreshAfter').value < 1){
        //   setTimeout(initMap, 30);
        // }
        // else{
        //   setTimeout(initMap, document.getElementById('refreshAfter').value*1000);
        // }
      } //initMap
    </script>
    <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBIEa13gL2ScuXJUxMaUdPaRRpgTRMQwGU&callback=initMap">
    </script>
    
</body>


  <!-- Popup LOG-OUT Modal-->
    <div class="modal fade" id="readytoLeave" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLabel">You sure ready to Leave?</h5>
            <button class="close" type="button" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">×</span>
            </button>
          </div>
          <div class="modal-body">Select "Logout" below if you are ready to end your current session.</div>
          <div class="modal-footer">
            <button class="btn btn-secondary" type="button" data-dismiss="modal"><i class="fa fa-window-close"></i> Cancel</button>
            <a class="btn btn-primary" ng-click="logout()"><i class="fa fa-fw fa-sign-out"></i> Logout</a>
          </div>
        </div>
      </div>
    </div>
  </div>

</html>
